#!/usr/bin/env bash

export CVE_PATCHES_DIR=CVE-patches
export RCLONE_DIR=rclone

set -x
env

set -e -o pipefail

# Use our customized go.mod/go.sum with replacement for golang/x/crypto to v0.45.0
# for CVE-2025-47913
cp ${CVE_PATCHES_DIR}/rclone_patch_deps/go.mod "${RCLONE_DIR}"/go.mod
cp ${CVE_PATCHES_DIR}/rclone_patch_deps/go.sum "${RCLONE_DIR}"/go.sum

# Replace saferith in rclone with fix for s390x
cat <<EOF >>"${RCLONE_DIR}"/go.mod

replace github.com/cronokirby/saferith => ../${CVE_PATCHES_DIR}/saferith
EOF

# cat "${RCLONE_DIR}"/go.mod
