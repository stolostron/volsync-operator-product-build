#!/usr/bin/env bash

export CVE_PATCHES_DIR=CVE-patches
export RCLONE_DIR=rclone

set -x
env

set -e -o pipefail

# Replace saferith in rclone with fix for s390x
cat <<EOF >>"${RCLONE_DIR}"/go.mod

replace github.com/cronokirby/saferith => ../${CVE_PATCHES_DIR}/saferith
EOF

# Replace golang.org/x/crypto (with the same version volsync uses so it should
# already be cached with cachito).  This is for CVE-2025-47913
sed -i 's|golang.org/x/crypto v0.42.0|golang.org/x/crypto v0.45.0|g' "${RCLONE_DIR}"/go.mod

cat "${RCLONE_DIR}"/go.mod
